<!DOCTYPE html>
<html>
<head>
    <title>Simple Kokoro TTS Streaming</title>
</head>
<body>
    <h1>Simple Kokoro TTS Streaming</h1>
    
    <textarea id="text" rows="4" cols="50" placeholder="Enter text here...">Hello, this is a simple streaming test with Kokoro TTS using GPU acceleration.</textarea>
    <br><br>
    
    <button onclick="connect()">Connect</button>
    <button onclick="startStream()" disabled id="streamBtn">Start Streaming</button>
    <button onclick="stopStream()" disabled id="stopBtn">Stop</button>
    <br><br>
    
    <div id="status">Ready</div>
    <br>
    
    <div id="audio"></div>

    <script>
        let ws = null;
        let isStreaming = false;
        let audioContext = null;
        let nextStartTime = 0;
        let streamingStarted = false;

        function connect() {
            ws = new WebSocket('ws://localhost:5000/ws');
            
            ws.onopen = function() {
                document.getElementById('status').innerText = 'Connected';
                document.getElementById('streamBtn').disabled = false;
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'stream_chunk') {
                    addChunk(data.chunk_data);
                    document.getElementById('status').innerText = 'Chunk ' + data.chunk_number;
                }
                else if (data.type === 'stream_complete') {
                    finishStream();
                    document.getElementById('status').innerText = 'Complete';
                }
                else if (data.type === 'error') {
                    document.getElementById('status').innerText = 'Error: ' + data.message;
                }
            };
            
            ws.onclose = function() {
                document.getElementById('status').innerText = 'Disconnected';
                document.getElementById('streamBtn').disabled = true;
            };
        }

        function startStream() {
            const text = document.getElementById('text').value.trim();
            if (!text) return;
            
            isStreaming = true;
            document.getElementById('streamBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('audio').innerHTML = '';

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            nextStartTime = audioContext.currentTime;
            streamingStarted = false;

            ws.send(JSON.stringify({
                type: 'stream_audio',
                text: text,
                voice: 'af_heart'
            }));
        }

        function addChunk(chunkData) {
            // Convert base64 to array
            const audioBytes = atob(chunkData);
            const audioArray = new Uint8Array(audioBytes.length);
            for (let i = 0; i < audioBytes.length; i++) {
                audioArray[i] = audioBytes.charCodeAt(i);
            }

            // Convert Int16 PCM to Float32
            const samples = audioArray.length / 2;
            const floatData = new Float32Array(samples);
            for (let i = 0; i < samples; i++) {
                const lo = audioArray[i * 2];
                const hi = audioArray[i * 2 + 1];
                let sample = (hi << 8) | lo;
                if (sample >= 0x8000) sample = sample - 0x10000;
                floatData[i] = sample / 32768;
            }

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const buffer = audioContext.createBuffer(1, floatData.length, 24000);
            buffer.copyToChannel(floatData, 0);

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);

            const startTime = Math.max(nextStartTime, audioContext.currentTime);
            source.start(startTime);
            nextStartTime = startTime + buffer.duration;
            streamingStarted = true;
        }

        function finishStream() {
            isStreaming = false;
            document.getElementById('streamBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function stopStream() {
            if (isStreaming) {
                ws.send(JSON.stringify({ type: 'stop_streaming' }));
                finishStream();
            }
            isStreaming = false;
            streamingStarted = false;
            nextStartTime = audioContext ? audioContext.currentTime : 0;
        }
    </script>
</body>
</html>
